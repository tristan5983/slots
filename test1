<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Nickel Token Slots Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Styles from original source */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .font-display { font-family: 'Righteous', cursive; }
        .dot { display: flex; align-items: center; justify-content: center; }
        @keyframes spin-fast { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin-fast 0.1s linear infinite; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
    <!-- PHP Inclusion of session start - Required for robust session use -->
    <?php require 'config.php'; ?>

    <div id="app-container" class="w-full max-w-lg mx-auto bg-slate-800 rounded-2xl shadow-2xl p-6 border-4 border-cyan-400/80">
        <!-- Content will be rendered here by JS -->
        <div class="text-center p-8 text-xl text-cyan-400">Loading Application...</div>
    </div>
    
<script>
    const INITIAL_BALANCE = 500;
    let state = {
        userId: null,
        balance: INITIAL_BALANCE,
        isLoading: true,
        error: null,
        isAuthReady: false,
        currentGame: 'slots',
        isGameActive: false,
        slotsReels: ['?', '?', '?'],
        slotsMessage: 'Place your bet and spin!',
        slotsBetAmount: 10,
        rouletteResult: null,
        rouletteMessage: 'Place your bet on Red or Black.',
        rouletteBetAmount: 50,
        diceRollResult: null,
        diceMessage: 'Guess if the roll will be High (7+) or Low (6-).',
        diceBetAmount: 25,
    };

    const appContainer = document.getElementById('app-container');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showLogin() {
        // This is the HTML that was missing from your previous render
        appContainer.innerHTML = `
            <div class="text-center p-8">
                <h2 class="text-5xl font-display text-cyan-400 mb-8">Big Nickel Casino</h2>
                <p class="text-red-400 mb-4">You must log in to play.</p>
                <input id="username" placeholder="Username" class="w-full p-3 rounded mb-3 bg-slate-700 text-white">
                <input id="password" type="password" placeholder="Password" class="w-full p-3 rounded mb-4 bg-slate-700 text-white">
                <div class="flex gap-3">
                    <button onclick="login()" class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-3 rounded font-bold text-lg">Login</button>
                    <button onclick="register()" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded font-bold text-lg">Register</button>
                </div>
                <p id="auth-msg" class="mt-4 text-red-400 h-6"></p>
            </div>`;
    }

    async function login() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        const res = await fetch('login.php', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'login',username:u,password:p})});
        const data = await res.json();
        if(data.success){ 
            // On successful login, update state and load balance
            state.isAuthReady = true; 
            await loadBalance(); 
            renderApp(); 
        } else {
            document.getElementById('auth-msg').textContent = data.msg || "Login failed";
        }
    }

    async function register() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        const res = await fetch('login.php', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'register',username:u,password:p})});
        const data = await res.json();
        if(data.success) {
            // Immediately log in after successful registration
            await login(); 
        } else {
            document.getElementById('auth-msg').textContent = data.msg || "Register failed";
        }
    }

    async function logout() {
        await fetch('logout.php');
        // Reloading the page will naturally trigger showLogin() again
        location.reload();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BALANCE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadBalance() {
        state.isLoading = true;
        renderApp(); // Show loading state immediately

        const res = await fetch('api/balance.php');
        const data = await res.json();
        
        if (data.balance !== undefined) {
            state.balance = data.balance;
            state.isLoading = false;
        } else if (data.error === 'Not logged in') {
            // This is the correct way to handle a session timeout/missing session
            state.isAuthReady = false;
            showLogin();
            return; // Exit here to prevent renderApp from running with incorrect state
        } else {
            state.error = data.error || "Failed to load balance from API.";
            state.isLoading = false;
        }
        state.isAuthReady = true; // Confirmed auth ready if balance loaded
        renderApp();
    }

    async function deductBet(amount) {
        const res = await fetch('api/bet.php', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount})});
        const data = await res.json();
        if (!data.success && data.insufficient) throw new Error("Insufficient funds");
        if (!data.success) throw new Error("Bet failed");
        await loadBalance();
    }

    async function addWin(amount) {
        await fetch('api/win.php', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount})});
        await loadBalance();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RENDERING HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const updateState = (newState) => { 
        Object.assign(state, newState); 
        renderApp(); 
    };
    
    const renderLoading = () => `<div class="text-center p-8 text-xl text-cyan-400">
        <svg class="animate-spin h-8 w-8 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>Connecting to database...</p>
    </div>`;
    
    const renderError = (msg) => `<div class="text-center p-8 text-red-500">Error: ${msg}</div>`;

    const DiceFace = (value) => { 
        const dots = [];
        const patterns = {
            1: [5], 2: [0, 10], 3: [0, 5, 10], 4: [0, 2, 8, 10], 5: [0, 2, 5, 8, 10], 6: [0, 2, 3, 7, 8, 10]
        };
        for(let i = 0; i < 11; i++) {
            dots.push(`<div key=${i} class="w-2 h-2 rounded-full ${patterns[value].includes(i) ? 'bg-black' : 'opacity-0'}"></div>`);
        }
        return `<div class="grid grid-cols-3 gap-1 p-2 bg-white w-12 h-12 rounded-lg shadow-lg">${dots.join('')}</div>`;
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€ Placeholder for Original Render Functions â”€â”€â”€â”€â”€â”€â”€â”€
    // Since the original code was not provided, we must use placeholders
    // to allow renderApp to run without errors.

    const renderGameButton = (name) => {
        const isCurrent = state.currentGame === name.toLowerCase();
        return `<button onclick="setCurrentGame('${name.toLowerCase()}')" 
            class="flex-1 py-3 rounded font-bold text-lg transition ${isCurrent ? 'bg-cyan-600' : 'bg-slate-700 hover:bg-slate-600'}">
            ${name}
        </button>`;
    };
    
    const renderSlotMachine = () => {
        return `<div class="text-center">
            <div class="flex justify-center my-6 space-x-4">
                ${state.slotsReels.map(r => `<div class="text-6xl p-4 w-1/4 h-20 bg-slate-700 rounded-lg text-yellow-500 flex items-center justify-center">${r}</div>`).join('')}
            </div>
            <p class="text-xl h-6 text-yellow-500 mb-6">${state.slotsMessage}</p>
            <div class="flex justify-center items-center space-x-4 mb-6">
                <label class="text-white">Bet:</label>
                <input type="number" min="10" max="100" step="10" value="${state.slotsBetAmount}" onchange="setSlotsBet(this.value)" 
                       class="w-20 p-2 rounded bg-slate-700 text-white text-center">
                <button onclick="spinSlots()" ${state.isGameActive || state.balance < state.slotsBetAmount ? 'disabled' : ''} 
                        class="bg-yellow-500 hover:bg-yellow-600 py-3 px-8 rounded font-bold text-lg disabled:opacity-50 transition">
                    Spin
                </button>
            </div>
            <p class="text-sm text-cyan-400">Match 3 symbols for a big win!</p>
        </div>`;
    };

    const renderRoulette = () => {
        const result = state.rouletteResult ? `<p class="text-3xl font-bold mb-4 text-${state.rouletteResult === 'Red' ? 'red' : 'white'}-500">${state.rouletteResult} Wins!</p>` : '';
        return `<div class="text-center">
            ${result}
            <p class="text-xl h-6 text-yellow-500 mb-6">${state.rouletteMessage}</p>
            <div class="flex justify-center space-x-4 mb-6">
                <button onclick="handleBetRoulette('Red')" class="bg-red-600 hover:bg-red-700 py-3 px-8 rounded font-bold text-lg disabled:opacity-50 transition">Bet Red</button>
                <button onclick="handleBetRoulette('Black')" class="bg-black text-white border-2 border-white/50 hover:bg-gray-800 py-3 px-8 rounded font-bold text-lg disabled:opacity-50 transition">Bet Black</button>
            </div>
            <div class="flex justify-center items-center space-x-4 mb-6">
                <label class="text-white">Bet:</label>
                <input type="number" min="10" max="100" step="10" value="${state.rouletteBetAmount}" onchange="setRouletteBet(this.value)" 
                       class="w-20 p-2 rounded bg-slate-700 text-white text-center">
            </div>
            <p class="text-sm text-cyan-400">Winning color pays 2x your bet.</p>
        </div>`;
    };

    const renderDiceRoll = () => {
        const resultHtml = state.diceRollResult 
            ? `<div class="flex justify-center space-x-4 mb-4">
                 ${DiceFace(state.diceRollResult[0])}
                 ${DiceFace(state.diceRollResult[1])}
               </div>
               <p class="text-3xl font-bold text-yellow-500 mb-4">Total: ${state.diceRollResult[0] + state.diceRollResult[1]}</p>`
            : `<p class="text-6xl text-cyan-400 mb-6 h-20">ðŸŽ²ðŸŽ²</p>`;
            
        return `<div class="text-center">
            ${resultHtml}
            <p class="text-xl h-6 text-yellow-500 mb-6">${state.diceMessage}</p>
            <div class="flex justify-center space-x-4 mb-6">
                <button onclick="rollDice('High')" class="bg-green-600 hover:bg-green-700 py-3 px-8 rounded font-bold text-lg disabled:opacity-50 transition">Guess High (7+)</button>
                <button onclick="rollDice('Low')" class="bg-red-600 text-white hover:bg-red-700 py-3 px-8 rounded font-bold text-lg disabled:opacity-50 transition">Guess Low (6-)</button>
            </div>
            <div class="flex justify-center items-center space-x-4 mb-6">
                <label class="text-white">Bet:</label>
                <input type="number" min="10" max="100" step="10" value="${state.diceBetAmount}" onchange="setDiceBet(this.value)" 
                       class="w-20 p-2 rounded bg-slate-700 text-white text-center">
            </div>
            <p class="text-sm text-cyan-400">Winning guess pays 2x your bet.</p>
        </div>`;
    };
    // â”€â”€â”€â”€â”€â”€â”€â”€ End Placeholder for Original Render Functions â”€â”€â”€â”€â”€â”€â”€â”€
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GAME LOGIC (dummy functions for placeholders) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.setSlotsBet = (v) => updateState({slotsBetAmount: parseInt(v) || 10});
    window.setDiceBet = (v) => updateState({diceBetAmount: parseInt(v) || 25});
    window.setRouletteBet = (v) => updateState({rouletteBetAmount: parseInt(v) || 50});
    window.setCurrentGame = (game) => updateState({currentGame: game, isGameActive: false});

    window.spinSlots = async () => {    
        const BET_AMOUNT = state.slotsBetAmount;
        if (state.isGameActive || state.balance < BET_AMOUNT) return;
        updateState({isGameActive:true, slotsMessage:`Spinning ${BET_AMOUNT} Tokens...`, slotsReels:['?','?','?']});
        try {        
            await deductBet(BET_AMOUNT);                         
            setTimeout(() => { 
                const symbols = ['ðŸ’', 'ðŸ‹', '7ï¸âƒ£', 'ðŸ””'];
                const finalReels = [
                    symbols[Math.floor(Math.random() * symbols.length)],
                    symbols[Math.floor(Math.random() * symbols.length)],
                    symbols[Math.floor(Math.random() * symbols.length)],
                ];
                determineSlotWin(finalReels, BET_AMOUNT);
            }, 2000);
        } catch(e) {
            updateState({isGameActive:false, slotsMessage: e.message.includes("Insufficient") ? "Not enough tokens!" : "Error"});
        }
    };

    const determineSlotWin = async (finalReels, BET_AMOUNT) => {
        let profit = 0;
        const [r1, r2, r3] = finalReels;
        if (r1 === r2 && r2 === r3) {
            profit = r1 === '7ï¸âƒ£' ? 100 : 50; // Triple 7s pay more
        } else if (r1 === r2 || r2 === r3 || r1 === r3) {
            profit = 10; // Double match
        }

        if (profit > 0) {
            await addWin(profit + BET_AMOUNT);
            updateState({isGameActive: false, slotsReels: finalReels, slotsMessage: `YOU WON ${profit + BET_AMOUNT}!`});
        } else {
            updateState({isGameActive: false, slotsReels: finalReels, slotsMessage: "Try again!"});
        }
    };
    
    window.handleBetRoulette = async (color) => {
        const BET_AMOUNT = state.rouletteBetAmount;
        if (state.isGameActive || state.balance < BET_AMOUNT) return;
        updateState({isGameActive:true, rouletteMessage:`Betting ${BET_AMOUNT} on ${color.toUpperCase()}...`});
        try {
            await deductBet(BET_AMOUNT);
            setTimeout(async () => {
                const roll = Math.floor(Math.random() * 37); // 0-36
                const resultColor = (roll === 0) ? 'Green' : (roll % 2 === 0) ? 'Red' : 'Black';
                const youWon = (resultColor.toUpperCase() === color.toUpperCase());
                
                let winAmount = 0;
                if (youWon) {
                    winAmount = 2 * BET_AMOUNT;
                    await addWin(winAmount);
                }

                updateState({
                    isGameActive:false, 
                    rouletteResult: resultColor,
                    rouletteMessage: winAmount > 0 ? `Landed on ${resultColor}! You win ${winAmount} tokens!` : `Landed on ${resultColor}. Better luck next time.`
                });
            }, 3000);
        } catch(e) { 
            updateState({isGameActive:false, rouletteMessage: e.message.includes("Insufficient") ? "Not enough tokens!" : "Error"});
        }
    };

    window.rollDice = async (guess) => {
        const BET_AMOUNT = state.diceBetAmount;
        if (state.isGameActive || state.balance < BET_AMOUNT) return;
        updateState({isGameActive:true, diceMessage:`Rolling...`});
        try {
            await deductBet(BET_AMOUNT);
            setTimeout(async () => {
                const die1 = Math.floor(Math.random() * 6) + 1;
                const die2 = Math.floor(Math.random() * 6) + 1;
                const total = die1 + die2;
                
                let win = false;
                if (guess === 'High' && total >= 7) win = true;
                if (guess === 'Low' && total <= 6) win = true;

                let winAmount = 0;
                if (win) {
                    winAmount = 2 * BET_AMOUNT;
                    await addWin(winAmount);
                }

                updateState({
                    isGameActive:false, 
                    diceRollResult: [die1, die2],
                    diceMessage: winAmount > 0 ? `Total is ${total}! You win ${winAmount} tokens!` : `Total is ${total}. You lose.`
                });
            }, 2000);
        } catch(e) { 
            updateState({isGameActive:false, diceMessage: e.message.includes("Insufficient") ? "Not enough tokens!" : "Error"});
        }
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const renderApp = () => {
        if (!state.isAuthReady) {
            // If auth is not ready (i.e., user not logged in), show login screen
            showLogin();
            return;
        }

        const header = `<header class="text-center mb-6">
            <h1 class="text-4xl font-display text-yellow-500 border-b-4 border-yellow-500 inline-block pb-1 tracking-widest">
                MOBILE CASINO
            </h1>
            <p class="text-xl text-white mt-4">Balance: <span class="text-cyan-400 font-bold">$${state.balance}</span></p>
            <div class="flex justify-center gap-2 mt-4">
                ${renderGameButton('Slots')}
                ${renderGameButton('Roulette')}
                ${renderGameButton('Dice')}
            </div>
        </header>`;

        let gameContent;
        if (state.isLoading) {
            gameContent = renderLoading();
        } else if (state.error) {
            gameContent = renderError(state.error);
        } else {
            switch (state.currentGame) {
                case 'slots':
                    gameContent = renderSlotMachine();
                    break;
                case 'roulette':
                    gameContent = renderRoulette();
                    break;
                case 'dice':
                    gameContent = renderDiceRoll();
                    break;
                default:
                    gameContent = renderError("Game not found.");
            }
        }

        const footer = `<footer class="mt-8 pt-4 border-t border-slate-700">
            <p class="text-center text-xs text-slate-500">Simulation Game - Funds are not real currency.</p>
            <button onclick="logout()" class="mt-4 w-full bg-red-600 hover:bg-red-700 py-2 rounded font-bold text-sm text-white transition">
                Logout
            </button>
        </footer>`;
        
        appContainer.innerHTML = header + gameContent + footer;
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Check if a PHP session is currently active
    const phpSessionActive = document.cookie.includes('PHPSESSID');

    if (phpSessionActive) {
        // If a session exists, try to load the balance immediately
        loadBalance();
    } else {
        // If no session exists, skip the API call and go straight to login UI
        showLogin();
    }
</script>
</body>
</html>
